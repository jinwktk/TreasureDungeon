# TreasureDungeonLegacy

## 概要
FFXIVのトレジャーハント（G10/G17地図）を完全自動化するLuaスクリプトです。地図の購入から発掘、戦闘、ダンジョン探索まで全工程を自動実行します。

## 新バージョン情報 (v2.0.0)
**作成日**: 2025-07-12  
**API対応**: SomethingNeedDoing v12.0.0.0+対応  
**設計**: Plan.mdの仕様に基づく完全再設計

### 主な改善点
- **モジュールベースAPI**: 新しいSND v12.0.0.0+のAPI構造に完全対応
- **フェーズ管理**: 明確な4段階フェーズ管理（地図購入→移動→ダンジョン外戦闘→ダンジョン）
- **ダンジョンタイプ自動判定**: ダンジョンタイプ・ルーレットタイプの自動識別
- **包括的エラー処理**: ロバストなエラー処理とリトライ機能

## 機能概要

### 1. 地図購入Phase
- **地図所持チェック**: インベントリ内の地図有無を自動判定
- **マーケットボード購入**: 地図未所持時の自動購入（実装予定）
- **地図解読**: ディサイファー自動実行
- **フラグテレポート**: 発掘地点への自動テレポート

### 2. 移動Phase
- **vnavmesh移動**: フラグ地点までの自動ナビゲーション
- **発掘処理**: 地点到着後のディグ自動実行
- **宝箱検出**: 宝箱の自動検索・移動・インタラクト

### 3. ダンジョン外戦闘Phase
- **戦闘システム**: RSR・BMRの自動制御
- **転送魔紋検出**: 戦闘後の転送魔紋検索
- **ダンジョン突入**: 転送魔紋経由でのダンジョン突入

### 4. ダンジョンPhase
- **タイプ自動判定**: 
  - **ダンジョンタイプ**: 通常の階層型ダンジョン
  - **ルーレットタイプ**: 召喚魔法陣ベースのランダム戦闘
- **自動探索**: 宝箱・皮袋の自動回収
- **ボス戦対応**: 最終層ボス（ゴールデン・モルター・ブルアポリオン）対応
- **自動脱出**: 最終層完了後の自動脱出

## 技術仕様

### 対応API (SND v12.0.0.0+)
```lua
-- モジュールベースAPI使用例
Player.Available                          -- プレイヤー操作可能状態
Player.Job.Id                            -- 現在のジョブID
Addons.GetAddon("AddonName").Ready        -- アドオン表示状態
Inventory.GetItemCount(itemId)            -- アイテム数取得
Instances.EnvManager.ActiveWeather        -- 現在の天候
```

### 依存プラグイン

#### 必須
- Something Need Doing [Expanded Edition] v12.0.0.0+
- vnavmesh（ナビゲーション）
- RSR（Rotation Solver Reborn）
- BMR（BossMod Reborn）

#### オプション
- AutoHook（釣り関連機能）
- Artisan（製作関連機能）

## 設定

### 地図設定
```lua
local MAP_ITEM_ID = 36636  -- G10地図のアイテムID
local MAP_NAME = "G10地図"
local MAX_DUNGEON_FLOORS = 7  -- 最大階層数
```

### デバッグ設定
```lua
local DEBUG_MODE = true  -- デバッグログの有効/無効
```

## 使用方法

1. **前提条件確認**
   - SomethingNeedDoing v12.0.0.0+がインストール済み
   - 必須プラグインが有効
   - 適切なジョブに切り替え済み

2. **スクリプト実行**
   ```
   /runcode TreasureDungeon.lua
   ```

3. **自動処理**
   - 地図の有無を自動判定
   - 必要に応じて購入・解読
   - フラグ地点まで自動移動
   - ダンジョン探索を全自動実行

## フェーズ制御

### 状態管理
```lua
local CurrentPhase = {
    MAP_PURCHASE = "地図購入",
    MOVEMENT = "移動",
    FIELD_COMBAT = "ダンジョン外戦闘", 
    DUNGEON = "ダンジョン"
}
```

### フェーズ遷移
1. **地図購入** → **移動** （テレポート完了時）
2. **移動** → **ダンジョン外戦闘** （宝箱発見時）
3. **ダンジョン外戦闘** → **ダンジョン** （転送魔紋発見時）
4. **ダンジョン外戦闘** → **地図購入** （転送魔紋なし時）
5. **ダンジョン** → **地図購入** （脱出完了時）

## エラー処理

### タイムアウト制御
- 移動タイムアウト: 5分
- 戦闘開始タイムアウト: 30秒
- アドオン表示タイムアウト: 30秒

### フェールセーフ
- 無限ループ防止（最大1000イテレーション）
- プレイヤー状態チェック
- API存在確認

## ログシステム

### デバッグ出力例
```
[TreasureDungeon] === 地図購入Phase開始 ===
[TreasureDungeon] 地図を所持済み - ディグ実行
[TreasureDungeon] フラグ地点にテレポート中...
[TreasureDungeon] === 移動Phase開始 ===
```

## 制限事項・今後の実装予定

### 現在の制限
- マーケットボード購入機能は仮実装
- 装備修理・チョコボ召喚・食事更新は仮実装
- 一部のターゲット検索API（`GetTargetName()`等）は要検証

### 今後の実装予定
- 実際のマーケットボード操作API調査・実装
- メンテナンス機能の詳細実装
- エラー発生時のリカバリー機能強化
- 設定ファイル外部化

## 注意事項
- FFXIVの利用規約を遵守してください
- 自動化スクリプトの使用は自己責任で行ってください
- 本スクリプトは教育・研究目的で作成されています

## 作者情報
- **Original Design**: Plan.md仕様書に基づく
- **Implementation**: Claude (2025-07-12)
- **API Reference**: SomethingNeedDoing v12.0.0.0+

## バージョン履歴

### v2.0.0 (2025-07-12) - 完全再設計
- Plan.md仕様に基づく完全再実装
- SomethingNeedDoing v12.0.0.0+対応
- モジュールベースAPI移行
- 4段階フェーズ管理システム導入
- ダンジョンタイプ自動判定機能