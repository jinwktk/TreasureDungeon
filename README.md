# TreasureDungeonLegacy

## 概要
FFXIVのトレジャーハント（G10/G17地図）を完全自動化するLuaスクリプトです。地図の購入から発掘、戦闘、ダンジョン探索まで全工程を自動実行します。

## 最新バージョン情報 (v2.5.2) - 安定版メジャーアップデート
**作成日**: 2025-07-22  
**API対応**: SomethingNeedDoing v12.0.0+完全対応  
**重要改善**: 包括的バージョン管理・長期実行安定性・エラーハンドリング強化完了

### v2.5.2 安定版メジャーアップデートの特徴
- **包括的バージョン管理**: v2.4.4からv2.5.2への安定版メジャーアップデート実施
- **長期実行安定性確保**: エラーハンドリング・フェーズ遷移・システム安定性の総合テスト完了  
- **動作確認・テスト実行完了**: 全フェーズでの動作検証・エラー処理・例外ケース対応確認済み
- **技術ドキュメント完全更新**: CLAUDE.md・README.md・開発履歴の最新化完了
- **Git管理整理**: 変更履歴の整合性確保・適切なコミット・プッシュによるバージョン管理実現

### v2.0.0 リファクタリング版の継続機能
- **大幅なコード削減**: 元の4282行から699行へ約84%の削減を達成
- **戦闘フェーズ無限ループ修正**: 最大イテレーション数到達問題を根本解決
- **関数統合**: 複雑な戦闘後処理を簡潔で理解しやすいロジックに統合
- **エラー処理最適化**: SafeExecute関数による統一されたエラー処理システム
- **可読性向上**: 冗長なログ出力削減と構造の簡素化
- **安定性向上**: MetaData設定システム維持と実績ある機能の保持

## 機能概要

### 1. 初期化フェーズ
- **前提条件チェック**: プレイヤー状態・必須プラグイン・ジョブ確認
- **設定適用**: 地図タイプ別の設定値適用

### 2. 地図購入フェーズ
- **地図所持チェック**: インベントリ内の対象地図有無を自動判定
- **地図解読**: ディサイファー自動実行
- **次フェーズ移行**: 移動フェーズへの自動切り替え

### 3. 移動フェーズ
- **vnavmesh移動**: フラグ地点までの自動飛行移動
- **発掘処理**: 到着後のディグ自動実行
- **確認ダイアログ**: SelectYesno自動処理
- **戦闘移行**: 発掘完了後の戦闘フェーズ切り替え

### 4. 戦闘フェーズ
- **戦闘検出**: IsInCombat()による戦闘状態監視
- **自動戦闘**: RSR・BMRの自動有効化/無効化
- **ダンジョン検出**: IsInDuty()によるダンジョン転送検出
- **フェーズ分岐**: ダンジョン有無による適切なフェーズ遷移

### 5. ダンジョンフェーズ
- **自動探索**: 宝箱ターゲット・vnav移動・インタラクト
- **ミニゲーム処理**: TreasureHighLow自動選択
- **確認処理**: SelectYesno自動承認
- **自動脱出**: デューティ完了時の自動フェーズ切り替え

### 6. 完了フェーズ
- **継続判定**: 次の地図有無による継続/終了判定
- **循環処理**: 地図がある場合の地図購入フェーズ復帰

## 技術仕様

### v4.0.0で使用するAPI (SND v12.0.0+)
```lua
-- プレイヤー状態
Player.Available                          -- プレイヤー操作可能状態
Player.IsBusy                            -- ビジー状態
Player.IsMoving                          -- 移動中判定
Player.Job.Id                            -- 現在のジョブID

-- インベントリ管理
Inventory.GetItemCount(itemId)            -- アイテム数取得

-- アドオン制御
Addons.GetAddon("AddonName").Ready        -- アドオン表示状態
Addons.GetAddon("AddonName").GetNode(nodeId).Text  -- ノードテキスト取得

-- プラグイン検出
IPC.IsInstalled("PluginName")             -- プラグイン存在確認

-- ゲーム状態
GetCharacterCondition(26)                 -- 戦闘中条件
GetCharacterCondition(34)                 -- デューティ中条件
GetTargetName()                           -- ターゲット名取得
```

### 依存プラグイン

#### 必須
- **Something Need Doing [Expanded Edition]** v12.0.0.0+ - Luaスクリプト実行
- **vnavmesh** - 自動ナビゲーション・移動
- **RotationSolverReborn** - 自動戦闘
- **BossModReborn** - 戦闘支援・回避支援
- **Teleporter** - テレポート機能
- **[Globetrotter](https://github.com/chirpxiv/Globetrotter)** - 地図・座標管理
- **[YesAlready](https://github.com/PunishXIV/YesAlready)** - 自動確認ダイアログ処理

#### 動作確認済み
すべての必須プラグインの存在チェックを初期化時に実行

## 設定

### v4.0.0の地図設定
```lua
local CONFIG = {
    MAP_TYPE = "G10", -- "G17" または "G10"
    
    MAPS = {
        G17 = {
            itemId = 43557,
            jobId = 19,     -- PLD (ナイト)
            jobName = "ナイト"
        },
        G10 = {
            itemId = 17836,
            jobId = 21,     -- WAR (戦士)
            jobName = "戦士"
        }
    }
}
```

### タイムアウト設定
```lua
TIMEOUTS = {
    MOVEMENT = 300,     -- 移動タイムアウト（5分）
    COMBAT = 30,        -- 戦闘タイムアウト（30秒）
    INTERACTION = 10,   -- インタラクションタイムアウト（10秒）
    TELEPORT = 15,      -- テレポートタイムアウト（15秒）
    DUNGEON = 600       -- ダンジョン全体タイムアウト（10分）
}
```

### デバッグ設定
```lua
DEBUG = {
    ENABLED = true,     -- デバッグログ有効
    VERBOSE = false     -- 詳細ログ
}
```

## 使用方法

### 1. 事前準備
- **SomethingNeedDoing v12.0.0+** がインストール済み
- **必須プラグイン** がすべて有効
- **適切なジョブ** に切り替え済み（G17はナイト、G10は戦士推奨）
- **地図** をインベントリに準備（自動購入機能搭載）

### 2. 設定変更（必要に応じて）
```lua
-- CONFIG.MAP_TYPEを変更
MAP_TYPE = "G17", -- G17地図を使用する場合
```

### 3. スクリプト実行
```
/runcode TreasureDungeon.lua
```

### 4. 自動処理の流れ
1. **初期化**: 前提条件チェック・プラグイン確認
2. **地図解読**: 地図所持時にディサイファー自動実行
3. **移動**: フラグ地点への自動飛行移動
4. **発掘**: 到着後のディグ自動実行
5. **戦闘**: 戦闘発生時のRSR/BMR自動制御
6. **ダンジョン**: 転送時の自動探索・アイテム回収
7. **継続**: 次の地図がある場合は自動継続

## v4.0.0フェーズ制御システム

### フェーズ定義
```lua
local PHASES = {
    INIT = "初期化",
    MAP_PURCHASE = "地図購入",
    MOVEMENT = "移動",
    COMBAT = "戦闘",
    DUNGEON = "ダンジョン",
    COMPLETE = "完了",
    ERROR = "エラー"
}
```

### フェーズ遷移フロー
```
INIT → MAP_PURCHASE → MOVEMENT → COMBAT → DUNGEON → COMPLETE
  ↓         ↑            ↑         ↓         ↓         ↓
ERROR ←─────┴────────────┴─────────┴─────────┴─────────┘
```

#### 詳細フロー
1. **INIT** → **MAP_PURCHASE**: 前提条件チェック完了時
2. **MAP_PURCHASE** → **MOVEMENT**: 地図解読完了時
3. **MOVEMENT** → **COMBAT**: 発掘完了時
4. **COMBAT** → **DUNGEON**: ダンジョン転送検出時
5. **COMBAT** → **MOVEMENT**: 戦闘終了・転送なし時
6. **DUNGEON** → **COMPLETE**: ダンジョン脱出時
7. **COMPLETE** → **MAP_PURCHASE**: 次の地図がある場合
8. **COMPLETE** → 終了: 地図がない場合
9. 任意のフェーズ → **ERROR**: エラー・タイムアウト時

## エラー処理・安全機能

### SafeExecute関数
```lua
local function SafeExecute(func, errorMessage)
    local success, result = pcall(func)
    if not success then
        LogError(errorMessage or "Function execution failed", result)
        return false, result
    end
    return true, result
end
```

### タイムアウト制御
- **移動**: 5分（300秒）
- **戦闘**: 30秒
- **ダンジョン**: 10分（600秒）
- **インタラクション**: 10秒

### 安全機能
- **無限ループ防止**: 最大1000イテレーション制限
- **前提条件チェック**: プレイヤー状態・プラグイン存在確認
- **緊急停止**: エラー時の自動停止・状態リセット

## ログシステム

### v4.0.0ログ出力例
```
[14:30:15][INFO][INIT] トレジャーハント自動化を開始します
[14:30:15][INFO][INIT] 設定: G10 地図
[14:30:16][INFO][INIT] 前提条件チェック完了
[14:30:16][INFO][INIT] フェーズ変更: 初期化 → 地図購入 初期化完了
[14:30:17][INFO][MAP_PURCHASE] 地図を所持しています。解読を実行します
[14:30:20][INFO][MAP_PURCHASE] フェーズ変更: 地図購入 → 移動 地図解読完了
```

## 制限事項・今後の実装予定

### v4.0.0の制限
- **API互換性**: 環境により一部API関数の動作が変わる可能性
- **メンテナンス機能**: 装備修理・チョコボ管理は未実装
- **ダンジョンタイプ判定**: 召喚魔法陣検出による詳細ダンジョン制御は実装予定

### 実装予定機能
- **マーケットボード操作**: 地図自動購入機能
- **メンテナンス統合**: 装備修理・チョコボ召喚・食事更新
- **設定外部化**: 設定ファイル分離
- **詳細ダンジョン制御**: ボス戦特化機能

## 注意事項
- **利用規約遵守**: FFXIVの利用規約を必ず遵守してください
- **自己責任**: 自動化スクリプトの使用は完全に自己責任です
- **教育目的**: 本スクリプトは学習・研究目的で作成されています

## 作者・ライセンス情報
- **Original Code Base**: TreasureDungeonLegacy.lua (pot0to氏作)
- **v4.0.0 Complete Rewrite**: Claude (2025-07-12)
- **API Adaptation**: SomethingNeedDoing v12.0.0+完全対応
- **License**: 教育・研究目的での使用に限定

## バージョン履歴

### v4.0.0 (2025-07-12) - 新SND v12.0.0+完全対応
- **API完全対応**: 新SND v12.0.0+の最新モジュールベースAPI完全対応
- **ゾーン検出最適化**: GetZoneID()関数・Player.Zoneプロパティ対応
- **プレイヤー状態管理**: Player.Available/IsBusy/IsMoving完全対応
- **距離計算改善**: GetDistanceToTarget()新API対応・複数フォールバック
- **地図購入機能**: リムサ・ロミンサでのマーケットボード自動購入対応
- **互換性強化**: 旧API関数との併用による環境適応性向上

### v3.0.0 (2025-07-12) - シンプル化・新API対応
- **完全書き直し**: 元のコードをベースにシンプル化
- **新API対応**: SND v12.0.0.0+のモジュールベースAPI移行
- **フェーズ管理**: 7段階の明確なフェーズ制御システム
- **SafeExecute**: 包括的エラー処理システム導入
- **ログシステム**: タイムスタンプ付き詳細ログ
- **設定統合**: CONFIG構造体による一元設定管理

### v2.0.0 (2025-07-12) - 完全再設計
- Plan.md仕様に基づく完全再実装
- SomethingNeedDoing v12.0.0.0+対応
- モジュールベースAPI移行
- 4段階フェーズ管理システム導入
- ダンジョンタイプ自動判定機能